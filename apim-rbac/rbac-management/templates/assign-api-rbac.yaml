parameters:
  - name: subscriptionId
    type: string
    displayName: Subscription ID

  - name: azureSubscription
    displayName: Azure Subscription Service Connection
    type: string

  - name: resourceGroup
    type: string
    displayName: Resource Group

  - name: apimInstance
    type: string
    displayName: API Management Instance

  - name: userEmail
    type: string
    displayName: User Email

  - name: apiNames
    type: object
    displayName: API Names

  - name: scriptPath
    type: string
    displayName: Script Path Prefix (Optional)
    default: 'apim-rbac/rbac-management/scripts/' # Default to the root of 'apim-rbac'

steps:
  - task: AzureCLI@2
    displayName: 'Install Dependencies'
    inputs:
      azureSubscription: '${{ parameters.azureSubscription }}'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        sudo apt-get update
        sudo apt-get install -y jq dos2unix
        dos2unix "${{ parameters.scriptPath }}assign-api-roles.sh"
        chmod +x "${{ parameters.scriptPath }}assign-api-roles.sh"

  - task: AzureCLI@2
    displayName: 'Create and Assign API-Specific RBAC Roles'
    inputs:
      azureSubscription: '${{ parameters.azureSubscription }}'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        az account set --subscription ${{ parameters.subscriptionId }}
        bash "${{ parameters.scriptPath }}assign-api-roles.sh" \
          '${{ parameters.subscriptionId }}' \
          '${{ parameters.resourceGroup }}' \
          '${{ parameters.apimInstance }}' \
          '${{ parameters.userEmail }}' \
          '${{ convertToJson(parameters.apiNames) }}'